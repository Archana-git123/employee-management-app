{"version":3,"file":"context.js","sources":["../src/context.tsx"],"sourcesContent":["import type {\n  GraphQLArgument,\n  GraphQLField,\n  GraphQLInputField,\n  GraphQLNamedType,\n  GraphQLSchema,\n} from 'graphql';\nimport {\n  isEnumType,\n  isInputObjectType,\n  isInterfaceType,\n  isNamedType,\n  isObjectType,\n  isScalarType,\n  isUnionType,\n} from 'graphql';\nimport { FC, ReactElement, ReactNode, useEffect } from 'react';\nimport {\n  SchemaReference,\n  useGraphiQL,\n  pick,\n  createBoundedUseStore,\n  GraphiQLPlugin,\n  DocsFilledIcon,\n  DocsIcon,\n  isMacOs,\n} from '@graphiql/react';\nimport { createStore } from 'zustand';\nimport { getSchemaReference } from './schema-reference';\nimport { DocExplorer } from './components';\n\nexport const DOC_EXPLORER_PLUGIN: GraphiQLPlugin = {\n  title: 'Documentation Explorer',\n  icon: function Icon() {\n    const visiblePlugin = useGraphiQL(state => state.visiblePlugin);\n    return visiblePlugin === DOC_EXPLORER_PLUGIN ? (\n      <DocsFilledIcon />\n    ) : (\n      <DocsIcon />\n    );\n  },\n  content: DocExplorer,\n};\n\nexport type DocExplorerFieldDef =\n  | GraphQLField<unknown, unknown>\n  | GraphQLInputField\n  | GraphQLArgument;\n\nexport type DocExplorerNavStackItem = {\n  /**\n   * The name of the item.\n   */\n  name: string;\n  /**\n   * The definition object of the item, this can be a named type, a field, an\n   * input field or an argument.\n   */\n  def?: GraphQLNamedType | DocExplorerFieldDef;\n};\n\n// There's always at least one item in the nav stack\nexport type DocExplorerNavStack = [\n  DocExplorerNavStackItem,\n  ...DocExplorerNavStackItem[],\n];\n\nexport type DocExplorerStoreType = {\n  /**\n   * A stack of navigation items. The last item in the list is the current one.\n   * This list always contains at least one item.\n   */\n  explorerNavStack: DocExplorerNavStack;\n  actions: {\n    /**\n     * Push an item to the navigation stack.\n     * @param item The item that should be pushed to the stack.\n     */\n    push(item: DocExplorerNavStackItem): void;\n    /**\n     * Pop the last item from the navigation stack.\n     */\n    pop(): void;\n    /**\n     * Reset the navigation stack to its initial state, this will remove all but\n     * the initial stack item.\n     */\n    reset(): void;\n    resolveSchemaReferenceToNavItem(\n      schemaReference: SchemaReference | null,\n    ): void;\n    /**\n     * Replace the nav stack with an updated version using the new schema.\n     */\n    rebuildNavStackWithSchema(schema: GraphQLSchema): void;\n  };\n};\n\nconst INITIAL_NAV_STACK: DocExplorerNavStack = [{ name: 'Docs' }];\n\nexport const docExplorerStore = createStore<DocExplorerStoreType>(\n  (set, get) => ({\n    explorerNavStack: INITIAL_NAV_STACK,\n    actions: {\n      push(item) {\n        set(state => {\n          const curr = state.explorerNavStack;\n          const lastItem = curr.at(-1)!;\n          const explorerNavStack: DocExplorerNavStack =\n            // Avoid pushing duplicate items\n            lastItem.def === item.def ? curr : [...curr, item];\n\n          return { explorerNavStack };\n        });\n      },\n      pop() {\n        set(state => {\n          const curr = state.explorerNavStack;\n\n          const explorerNavStack =\n            curr.length > 1 ? (curr.slice(0, -1) as DocExplorerNavStack) : curr;\n\n          return { explorerNavStack };\n        });\n      },\n      reset() {\n        set(state => {\n          const curr = state.explorerNavStack;\n          const explorerNavStack = curr.length === 1 ? curr : INITIAL_NAV_STACK;\n          return { explorerNavStack };\n        });\n      },\n      resolveSchemaReferenceToNavItem(schemaReference) {\n        if (!schemaReference) {\n          return;\n        }\n        const { kind, typeInfo } = schemaReference;\n        const ref = getSchemaReference(kind, typeInfo);\n        if (!ref) {\n          return;\n        }\n\n        const { push } = get().actions;\n        switch (ref.kind) {\n          case 'Type': {\n            push({\n              name: ref.type.name,\n              def: ref.type,\n            });\n            break;\n          }\n          case 'Field': {\n            // Show a field type on stack\n            if (ref.type) {\n              push({\n                name: ref.type.name,\n                def: ref.type,\n              });\n            }\n            push({\n              name: ref.field.name,\n              def: ref.field,\n            });\n            break;\n          }\n          case 'Argument': {\n            if (ref.field) {\n              push({\n                name: ref.field.name,\n                def: ref.field,\n              });\n            }\n            break;\n          }\n          case 'EnumValue': {\n            if (ref.type) {\n              push({\n                name: ref.type.name,\n                def: ref.type,\n              });\n            }\n            break;\n          }\n        }\n      },\n      rebuildNavStackWithSchema(schema: GraphQLSchema) {\n        set(state => {\n          const oldNavStack = state.explorerNavStack;\n          if (oldNavStack.length === 1) {\n            return state;\n          }\n          // Spread is needed\n          const newNavStack: DocExplorerNavStack = [...INITIAL_NAV_STACK];\n          let lastEntity:\n            | GraphQLNamedType\n            | GraphQLField<unknown, unknown>\n            | null = null;\n          for (const item of oldNavStack) {\n            if (item === INITIAL_NAV_STACK[0]) {\n              // No need to copy the initial item\n              continue;\n            }\n            if (item.def) {\n              // If item.def isn't a named type, it must be a field, inputField, or argument\n              if (isNamedType(item.def)) {\n                // The type needs to be replaced with the new schema type of the same name\n                const newType = schema.getType(item.def.name);\n                if (newType) {\n                  newNavStack.push({\n                    name: item.name,\n                    def: newType,\n                  });\n                  lastEntity = newType;\n                } else {\n                  // This type no longer exists; the stack cannot be built beyond here\n                  break;\n                }\n              } else if (lastEntity === null) {\n                // We can't have a sub-entity if we have no entity; stop rebuilding the nav stack\n                break;\n              } else if (\n                isObjectType(lastEntity) ||\n                isInputObjectType(lastEntity)\n              ) {\n                // item.def must be a Field / input field; replace with the new field of the same name\n                const field = lastEntity.getFields()[item.name];\n                if (field) {\n                  newNavStack.push({\n                    name: item.name,\n                    def: field,\n                  });\n                } else {\n                  // This field no longer exists; the stack cannot be built beyond here\n                  break;\n                }\n              } else if (\n                isScalarType(lastEntity) ||\n                isEnumType(lastEntity) ||\n                isInterfaceType(lastEntity) ||\n                isUnionType(lastEntity)\n              ) {\n                // These don't (currently) have non-type sub-entries; something has gone wrong.\n                // Handle gracefully by discontinuing rebuilding the stack.\n                break;\n              } else {\n                // lastEntity must be a field (because it's not a named type)\n                const field: GraphQLField<unknown, unknown> = lastEntity;\n                // Thus item.def must be an argument, so find the same named argument in the new schema\n                if (field.args.some(a => a.name === item.name)) {\n                  newNavStack.push({\n                    name: item.name,\n                    def: field,\n                  });\n                } else {\n                  // This argument no longer exists; the stack cannot be built beyond here\n                  break;\n                }\n              }\n            } else {\n              lastEntity = null;\n              newNavStack.push(item);\n            }\n          }\n          return { explorerNavStack: newNavStack };\n        });\n      },\n    },\n  }),\n);\n\nexport const DocExplorerStore: FC<{\n  children: ReactNode;\n}> = ({ children }) => {\n  const { schema, validationErrors, schemaReference } = useGraphiQL(\n    pick('schema', 'validationErrors', 'schemaReference'),\n  );\n\n  useEffect(() => {\n    const { resolveSchemaReferenceToNavItem } =\n      docExplorerStore.getState().actions;\n    resolveSchemaReferenceToNavItem(schemaReference);\n  }, [schemaReference]);\n\n  useEffect(() => {\n    const { reset, rebuildNavStackWithSchema } =\n      docExplorerStore.getState().actions;\n\n    // Whenever the schema changes, we must revalidate/replace the nav stack.\n    if (schema == null || validationErrors.length > 0) {\n      reset();\n    } else {\n      rebuildNavStackWithSchema(schema);\n    }\n  }, [schema, validationErrors]);\n\n  useEffect(() => {\n    function handleKeyDown(event: KeyboardEvent) {\n      const shouldFocusInput =\n        // Use an additional `Alt` key instead of `Cmd/Ctrl+K` because monaco-editor has a built-in\n        // shortcut for `Cmd/Ctrl+K`\n        event.altKey &&\n        event[isMacOs ? 'metaKey' : 'ctrlKey'] &&\n        // Using `event.code` because `event.key` will trigger different character\n        // in English `˚` and in French `È`\n        event.code === 'KeyK';\n      if (!shouldFocusInput) {\n        return;\n      }\n      const button = document.querySelector<HTMLButtonElement>(\n        '.graphiql-sidebar button[aria-label=\"Show Documentation Explorer\"]',\n      );\n      button?.click();\n      // Execute on next tick when doc explorer is opened and input exists in DOM\n      requestAnimationFrame(() => {\n        const el = document.querySelector<HTMLDivElement>(\n          '.graphiql-doc-explorer-search-input',\n        );\n        el?.click();\n      });\n    }\n\n    window.addEventListener('keydown', handleKeyDown);\n    return () => {\n      window.removeEventListener('keydown', handleKeyDown);\n    };\n  }, []);\n\n  return children as ReactElement;\n};\n\nconst useDocExplorerStore = createBoundedUseStore(docExplorerStore);\n\nexport const useDocExplorer = () =>\n  useDocExplorerStore(state => state.explorerNavStack);\n\n/**\n * Actions are functions used to update values in your store. They are static and never change.\n * @see https://tkdodo.eu/blog/working-with-zustand#separate-actions-from-state\n */\nexport const useDocExplorerActions = () =>\n  useDocExplorerStore(state => state.actions);\n"],"names":["DOC_EXPLORER_PLUGIN","title","icon","Icon","visiblePlugin","useGraphiQL","state","content","DocExplorer","INITIAL_NAV_STACK","name","docExplorerStore","createStore","set","get","explorerNavStack","actions","push","item","curr","lastItem","at","def","pop","length","slice","reset","resolveSchemaReferenceToNavItem","schemaReference","kind","typeInfo","ref","getSchemaReference","type","field","rebuildNavStackWithSchema","schema","oldNavStack","newNavStack","lastEntity","isNamedType","newType","getType","isObjectType","isInputObjectType","getFields","isScalarType","isEnumType","isInterfaceType","isUnionType","args","some","a","DocExplorerStore","t0","$","_c","children","t1","Symbol","for","pick","validationErrors","t2","t3","getState","useEffect","t4","t5","t6","_temp2","useDocExplorerStore","createBoundedUseStore","useDocExplorer","_temp3","useDocExplorerActions","_temp4","_temp","el","document","querySelector","click","handleKeyDown","event","shouldFocusInput","altKey","isMacOs","code","button","requestAnimationFrame","addEventListener","removeEventListener"],"mappings":"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"}