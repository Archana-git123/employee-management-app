{"version":3,"file":"hooks.js","sources":["../../src/utility/hooks.ts"],"sourcesContent":["import { useEffect, useRef, useState } from 'react';\nimport { debounce } from './debounce';\nimport type * as monaco from 'monaco-editor';\nimport { useGraphiQL, useGraphiQLActions } from '../components';\n\nexport function useChangeHandler(\n  callback: ((value: string) => void) | undefined,\n  storageKey: string | null,\n  tabProperty: 'variables' | 'headers',\n) {\n  const { updateActiveTabValues } = useGraphiQLActions();\n  const { editor, storage } = useGraphiQL(state => ({\n    editor:\n      state[tabProperty === 'variables' ? 'variableEditor' : 'headerEditor'],\n    storage: state.storage,\n  }));\n  useEffect(() => {\n    if (!editor) {\n      return;\n    }\n    const store = debounce(500, (value: string) => {\n      if (storageKey === null) {\n        return;\n      }\n      storage.set(storageKey, value);\n    });\n    const updateTab = debounce(100, (value: string) => {\n      updateActiveTabValues({ [tabProperty]: value });\n    });\n\n    const handleChange = (_event: monaco.editor.IModelContentChangedEvent) => {\n      const newValue = editor.getValue();\n      store(newValue);\n      updateTab(newValue);\n      callback?.(newValue);\n    };\n    const disposable = editor.getModel()!.onDidChangeContent(handleChange);\n    return () => {\n      disposable.dispose();\n    };\n  }, [\n    callback,\n    editor,\n    storageKey,\n    tabProperty,\n    updateActiveTabValues,\n    storage,\n  ]);\n}\n\n// https://react.dev/learn/you-might-not-need-an-effect\nexport const useEditorState = (\n  editor: 'query' | 'variable' | 'header',\n): [string, (val: string) => void] => {\n  const editorInstance = useGraphiQL(state => state[`${editor}Editor`]);\n  const [value, setValue] = useState('');\n  const model = editorInstance?.getModel();\n\n  useEffect(() => {\n    if (!model) {\n      return;\n    }\n\n    function onChange() {\n      setValue(model!.getValue());\n    }\n\n    const disposable = model.onDidChangeContent(onChange);\n    // Initialize the value\n    onChange();\n    return () => {\n      disposable.dispose();\n    };\n  }, [model]);\n\n  function handleChange(newValue: string) {\n    model!.setValue(newValue);\n  }\n\n  return [value, handleChange];\n};\n\n/**\n * useState-like hook for the current tab operations editor state\n */\nexport const useOperationsEditorState = (): [\n  operations: string,\n  setOperations: (content: string) => void,\n] => {\n  return useEditorState('query');\n};\n\n/**\n * useState-like hook for current tab variables editor state\n */\nexport const useVariablesEditorState = (): [\n  variables: string,\n  setVariables: (content: string) => void,\n] => {\n  return useEditorState('variable');\n};\n\n/**\n * useState-like hook for current tab variables editor state\n */\nexport const useHeadersEditorState = (): [\n  headers: string,\n  setHeaders: (content: string) => void,\n] => {\n  return useEditorState('header');\n};\n\n/**\n * Implements an optimistic caching strategy around a useState-like hook in\n * order to prevent loss of updates when the hook has an internal delay and the\n * update function is called again before the updated state is sent out.\n *\n * Use this as a wrapper around `useOperationsEditorState`,\n * `useVariablesEditorState`, or `useHeadersEditorState` if you anticipate\n * calling them with great frequency (due to, for instance, mouse, keyboard, or\n * network events).\n *\n * @example\n * ```ts\n * const [operationsString, handleEditOperations] =\n *   useOptimisticState(useOperationsEditorState());\n * ```\n */\nexport function useOptimisticState([\n  upstreamState,\n  upstreamSetState,\n]: ReturnType<typeof useEditorState>): ReturnType<typeof useEditorState> {\n  const lastStateRef = useRef({\n    /** The last thing that we sent upstream; we're expecting this back */\n    pending: null as string | null,\n    /** The last thing we received from upstream */\n    last: upstreamState,\n  });\n\n  const [state, setOperationsText] = useState(upstreamState);\n\n  useEffect(() => {\n    if (lastStateRef.current.last === upstreamState) {\n      // No change; ignore\n      return;\n    }\n    lastStateRef.current.last = upstreamState;\n    if (lastStateRef.current.pending === null) {\n      // Gracefully accept update from upstream\n      setOperationsText(upstreamState);\n      return;\n    }\n    if (lastStateRef.current.pending === upstreamState) {\n      // They received our update and sent it back to us - clear pending, and\n      // send next if appropriate\n      lastStateRef.current.pending = null;\n      if (upstreamState !== state) {\n        // Change has occurred; upstream it\n        lastStateRef.current.pending = state;\n        upstreamSetState(state);\n      }\n      return;\n    }\n    // They got a different update; overwrite our local state (!!)\n    lastStateRef.current.pending = null;\n    setOperationsText(upstreamState);\n  }, [upstreamState, state, upstreamSetState]);\n\n  const setState = (newState: string) => {\n    setOperationsText(newState);\n    if (\n      lastStateRef.current.pending === null &&\n      lastStateRef.current.last !== newState\n    ) {\n      // No pending updates and change has occurred... send it upstream\n      lastStateRef.current.pending = newState;\n      upstreamSetState(newState);\n    }\n  };\n\n  return [state, setState];\n}\n\n// https://github.com/mantinedev/mantine/blob/master/packages/@mantine/hooks/src/use-did-update/use-did-update.ts\nexport const useDidUpdate: typeof useEffect = (fn, dependencies) => {\n  const didMountRef = useRef(false);\n\n  // React Strict Mode intentionally mounts → unmounts → mounts the component during development.\n  useEffect(() => {\n    return () => {\n      didMountRef.current = false;\n    };\n  }, []);\n\n  useEffect(() => {\n    if (didMountRef.current) {\n      return fn();\n    }\n    didMountRef.current = true;\n  }, dependencies); // eslint-disable-line react-hooks/exhaustive-deps\n};\n"],"names":["useChangeHandler","callback","storageKey","tabProperty","$","_c","updateActiveTabValues","useGraphiQLActions","t0","state","editor","storage","useGraphiQL","t1","t2","store","debounce","value","set","updateTab","value_0","handleChange","_event","newValue","getValue","disposable","getModel","onDidChangeContent","dispose","useEffect","useEditorState","editorInstance","setValue","useState","model","t3","onChange","t4","t5","useOperationsEditorState","useVariablesEditorState","useHeadersEditorState","useOptimisticState","upstreamState","upstreamSetState","pending","last","lastStateRef","useRef","setOperationsText","current","newState","setState","useDidUpdate","fn","dependencies","didMountRef","Symbol","for"],"mappings":"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"}