{"version":3,"file":"response-editor.js","sources":["../../src/components/response-editor.tsx"],"sourcesContent":["import { formatError } from '@graphiql/toolkit';\nimport { ComponentType, FC, useEffect, useRef } from 'react';\nimport { createRoot, Root } from 'react-dom/client';\nimport { useGraphiQL, useGraphiQLActions } from './provider';\nimport { ImagePreview } from './image-preview';\nimport {\n  getOrCreateModel,\n  createEditor,\n  onEditorContainerKeyDown,\n  pick,\n  cleanupDisposables,\n  cn,\n  Range,\n} from '../utility';\nimport { KEY_BINDINGS, URI_NAME } from '../constants';\nimport type { EditorProps } from '../types';\nimport type * as monaco from 'monaco-editor';\nimport { useMonaco } from '../stores';\n\ntype ResponseTooltipType = ComponentType<{\n  /**\n   * A position in the editor.\n   */\n  position: monaco.Position;\n  /**\n   * Word that has been hovered over.\n   */\n  word: monaco.editor.IWordAtPosition;\n}>;\n\ninterface ResponseEditorProps extends EditorProps {\n  /**\n   * Customize the tooltip when hovering over properties in the response editor.\n   */\n  responseTooltip?: ResponseTooltipType;\n}\n\nexport const ResponseEditor: FC<ResponseEditorProps> = ({\n  responseTooltip: ResponseTooltip,\n  ...props\n}) => {\n  const { setEditor, run } = useGraphiQLActions();\n  const { fetchError, validationErrors, responseEditor, uriInstanceId } =\n    useGraphiQL(\n      pick('fetchError', 'validationErrors', 'responseEditor', 'uriInstanceId'),\n    );\n  const ref = useRef<HTMLDivElement>(null!);\n  const monaco = useMonaco(state => state.monaco);\n  useEffect(() => {\n    if (fetchError) {\n      responseEditor?.setValue(fetchError);\n    }\n    if (validationErrors.length) {\n      responseEditor?.setValue(formatError(validationErrors));\n    }\n  }, [responseEditor, fetchError, validationErrors]);\n\n  useEffect(() => {\n    if (!monaco) {\n      return;\n    }\n    const model = getOrCreateModel({\n      uri: `${uriInstanceId}${URI_NAME.response}`,\n      value: '',\n    });\n    const editor = createEditor(ref, {\n      model,\n      readOnly: true,\n      lineNumbers: 'off',\n      wordWrap: 'on', // Toggle word wrap on resizing editors\n      contextmenu: false, // Disable the right-click context menu\n    });\n    setEditor({ responseEditor: editor });\n\n    let lastRoot: Root | undefined;\n    let timerId: ReturnType<typeof setTimeout> | undefined;\n\n    const provideHover: monaco.languages.HoverProvider['provideHover'] = (\n      $model,\n      position,\n    ) => {\n      const sameModel = $model.uri === model.uri;\n      if (!sameModel) {\n        return null; // Ignore for other editors\n      }\n      const wordAtPosition = $model.getWordAtPosition(position);\n      if (!wordAtPosition?.word.startsWith('/')) {\n        return null;\n      }\n      const shouldRender = ImagePreview.shouldRender(wordAtPosition.word);\n      if (!shouldRender) {\n        return null;\n      }\n\n      // Return a placeholder content with a unique ID for now\n      const hoverId = `hover-${position.lineNumber}-${position.column}`;\n      if (timerId) {\n        clearTimeout(timerId);\n      }\n      timerId = setTimeout(() => {\n        const el = document.querySelector<HTMLDivElement>(\n          `[data-id=\"${hoverId}\"]`,\n        );\n        if (!el) {\n          return;\n        }\n        lastRoot?.unmount();\n        lastRoot = createRoot(el);\n        lastRoot.render(\n          // Handle image tooltips and custom tooltips\n          <>\n            {ResponseTooltip && (\n              <ResponseTooltip position={position} word={wordAtPosition} />\n            )}\n            <ImagePreview path={wordAtPosition.word} />\n          </>,\n        );\n      }, 500);\n\n      return {\n        range: new Range(\n          position.lineNumber,\n          wordAtPosition.startColumn,\n          position.lineNumber,\n          wordAtPosition.endColumn,\n        ),\n        contents: [\n          {\n            value: `<div data-id=\"${hoverId}\">Loading...</div>`,\n            supportHtml: true,\n          },\n        ],\n      };\n    };\n    const languageId = model.getLanguageId();\n    const disposables = [\n      monaco.languages.registerHoverProvider(languageId, { provideHover }),\n      editor.addAction({ ...KEY_BINDINGS.runQuery, run }),\n      editor,\n      model,\n    ];\n    return cleanupDisposables(disposables);\n  }, [monaco]); // eslint-disable-line react-hooks/exhaustive-deps -- only on mount\n\n  return (\n    <section\n      ref={ref}\n      aria-label=\"Result Window\"\n      aria-live=\"polite\"\n      aria-atomic=\"true\"\n      tabIndex={0}\n      onKeyDown={onEditorContainerKeyDown}\n      {...props}\n      className={cn('result-window', props.className)}\n    />\n  );\n};\n"],"names":["ResponseEditor","t0","$","_c","ResponseTooltip","props","responseTooltip","setEditor","run","useGraphiQLActions","t1","Symbol","for","pick","fetchError","validationErrors","responseEditor","uriInstanceId","useGraphiQL","ref","useRef","monaco","useMonaco","_temp","t2","t3","setValue","length","formatError","useEffect","t4","model","getOrCreateModel","uri","URI_NAME","response","value","editor","createEditor","readOnly","lineNumbers","wordWrap","contextmenu","lastRoot","timerId","provideHover","$model","position","sameModel","wordAtPosition","getWordAtPosition","word","startsWith","shouldRender","ImagePreview","hoverId","lineNumber","column","clearTimeout","el","unmount","render","range","Range","startColumn","endColumn","contents","supportHtml","languageId","getLanguageId","disposables","languages","registerHoverProvider","addAction","KEY_BINDINGS","runQuery","cleanupDisposables","t5","t6","className","cn","t7","onEditorContainerKeyDown","state"],"mappings":"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"}